<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Summary cHJvZHVjdCxwcmljZSxzYWxlcwpBcHBsZSwxLjIwLDMw</title>
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl5+CkYp/5w4wlrSX/7XEkSmsBn0dk+9a05DL1Svgo" 
    crossorigin="anonymous"
    onerror="fallbackCSS()"
  />
  <style>
    /* Fallback CSS if Bootstrap fails to load */
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      border: 1px solid #dee2e6;
      padding: 1.5rem;
      border-radius: 0.5rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
    }
    .form-select {
      width: 100%;
    }
    .fs-4 {
      font-size: 1.5rem;
    }
    .fw-bold {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h1 class="mb-4" id="main-title">Sales Summary</h1>
    <!-- Currency picker and total display -->
    <div class="mb-3" id="currency-container">
      <label for="currency-picker" class="form-label">Select Currency:</label>
      <select id="currency-picker" class="form-select" aria-label="Currency selection">
        <option value="USD" selected>USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
        <option value="TH">TH</option>
      </select>
    </div>
    <p>Total sales: <span id="total-sales" class="fs-4">0.00</span> <span id="total-currency" class="fw-bold">USD</span></p>
  </div>
  <script>
    // Fallback function if Bootstrap CSS fails to load
    function fallbackCSS() {
      document.querySelector("style").textContent = `
        body {
          font-family: Arial, sans-serif;
          padding: 2rem;
          background-color: #f8f9fa;
        }
        .container {
          max-width: 600px;
          margin: auto;
          background: #fff;
          border: 1px solid #dee2e6;
          padding: 1.5rem;
          border-radius: 0.5rem;
        }
        .form-label {
          display: block;
          margin-bottom: 0.5rem;
        }
        .form-select {
          width: 100%;
        }
        .fs-4 {
          font-size: 1.5rem;
        }
        .fw-bold {
          font-weight: bold;
        }
      `;
    }

    (function() {
      const seed = "cHJvZHVjdCxwcmljZSxzYWxlcwpBcHBsZSwxLjIwLDMw";
      const expectedTitle = `Sales Summary ${seed}`;
      // Confirm or set document title
      if (document.title !== expectedTitle) {
        document.title = expectedTitle;
      }

      // Verify the CSS load (heuristic)
      const bootstrapLinks = Array.from(document.querySelectorAll("link[href*='bootstrap']"));
      const bootstrapLinked = bootstrapLinks.some(link => {
        // Basic check: ensure link is present
        return link && link.href.includes('bootstrap');
      });
      // Note: More robust load detection could involve onload event on the link, but omitted for simplicity

      // Embedded CSV data
      const csvData = `product,price,sales
Apple,1.20,30
Orange,1.45,40`;

      // Parse CSV and compute total sales in USD
      const lines = csvData.trim().split('\n');
      const headers = lines[0].split(',');
      const salesIdx = headers.indexOf('sales');
      const priceIdx = headers.indexOf('price');

      let totalUSD = 0;

      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        const salesStr = cols[salesIdx];
        const priceStr = cols[priceIdx];
        const salesNum = parseFloat(salesStr);
        const priceNum = parseFloat(priceStr);
        if (!isNaN(salesNum) && !isNaN(priceNum)) {
          totalUSD += priceNum * salesNum;
        }
      }

      // Display the total in the span
      const totalElem = document.querySelector('#total-sales');
      if (totalElem) {
        totalElem.textContent = totalUSD.toFixed(2);
      }

      // Verify total calculation within 0.01
      const checkResult = Math.abs(parseFloat(totalElem.textContent) - totalUSD) < 0.01;
      if (!checkResult) {
        console.warn('Total sales mismatch');
      }

      // Load rates.json data
      const rates = {"TH":1.0,"EUR":0.85,"GBP":0.75};

      // Set initial active currency
      const currencyPicker = document.querySelector('#currency-picker');
      const totalCurrencySpan = document.querySelector('#total-currency');

      if (!currencyPicker || !totalCurrencySpan) {
        console.error('Required elements missing');
        return;
      }

      const totalSalesSpan = document.querySelector('#total-sales');

      function convertTotal() {
        const selectedCurrency = currencyPicker.value;
        // Mirror active currency
        totalCurrencySpan.textContent = selectedCurrency;

        // Convert total to selected currency
        const rate = rates[selectedCurrency];
        const convertedTotal = totalUSD * rate;

        if (totalSalesSpan) {
          totalSalesSpan.textContent = convertedTotal.toFixed(2);
        }
      }

      // Initialize display
      convertTotal();

      // Add event listener to currency select
      currencyPicker.addEventListener('change', convertTotal);
    })();
  </script>
</body>
</html>